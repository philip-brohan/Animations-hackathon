<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Assemble data for the ML Diffusion video &#8212; Video Diagnostics</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinxdoc.css?v=34905f61" />
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Plot one frame of the ML Downscaling Diffusion video" href="plot.html" />
    <link rel="prev" title="Downscaling: Diffusion model" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="plot.html" title="Plot one frame of the ML Downscaling Diffusion video"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="index.html" title="Downscaling: Diffusion model"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Video Diagnostics</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Downscaling: Diffusion model</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Assemble data for the ML Diffusion video</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="assemble-data-for-the-ml-diffusion-video">
<h1>Assemble data for the ML Diffusion video<a class="headerlink" href="#assemble-data-for-the-ml-diffusion-video" title="Link to this heading">¶</a></h1>
<p>I got the data from Ben Booth - I’m not including it here.</p>
<p>Convenience functions to load and interpolate data.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Functions to load The ML precipitation data</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">iris</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">iris.cube</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">iris.coords</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">iris.coord_systems</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">iris.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">squeeze</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">iris.coord_systems</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">iris.util</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cftime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="c1"># Don&#39;t really understand this, but it gets rid of the error messages.</span>
<span class="n">iris</span><span class="o">.</span><span class="n">FUTURE</span><span class="o">.</span><span class="n">datum_support</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Coordinate system for the data</span>
<span class="n">ML_cs</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">RotatedGeogCS</span><span class="p">(</span>
    <span class="mf">37.5</span><span class="p">,</span> <span class="mf">177.5</span><span class="p">,</span> <span class="n">ellipsoid</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">GeogCS</span><span class="p">(</span><span class="mf">6371229.0</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Central data directory</span>
<span class="n">Ddir</span> <span class="o">=</span> <span class="s2">&quot;/data/users/backup/datadir/ben.booth/ML/UNET_output/Tests_Mar25&quot;</span>


<span class="c1"># And a function to add the coord system to a cube (in-place)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_coord_system</span><span class="p">(</span><span class="n">cbe</span><span class="p">):</span>
    <span class="n">cbe</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_latitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">=</span> <span class="n">ML_cs</span>
    <span class="n">cbe</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_longitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">=</span> <span class="n">ML_cs</span>


<span class="c1"># Make a higher-res cube on the same grid as the data for plotting</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_cube</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mf">357.75</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">363.25</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mf">2.75</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">2.75</span><span class="p">):</span>

    <span class="n">lat_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">(</span>
        <span class="n">lat_values</span><span class="p">,</span>
        <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;grid_latitude&quot;</span><span class="p">,</span>
        <span class="n">units</span><span class="o">=</span><span class="s2">&quot;degrees_north&quot;</span><span class="p">,</span>
        <span class="n">coord_system</span><span class="o">=</span><span class="n">ML_cs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">lon_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">(</span>
        <span class="n">lon_values</span><span class="p">,</span>
        <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;grid_longitude&quot;</span><span class="p">,</span>
        <span class="n">units</span><span class="o">=</span><span class="s2">&quot;degrees_east&quot;</span><span class="p">,</span>
        <span class="n">coord_system</span><span class="o">=</span><span class="n">ML_cs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lat_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_values</span><span class="p">)))</span>
    <span class="n">plot_cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">Cube</span><span class="p">(</span>
        <span class="n">dummy_data</span><span class="p">,</span> <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[(</span><span class="n">latitude</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plot_cube</span>


<span class="n">default_cube</span> <span class="o">=</span> <span class="n">plot_cube</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_land_mask</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">default_cube</span><span class="p">):</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/fixed_fields/land_mask/opfc_global_2019.nc&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATADIR&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No data file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">land_mask</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">load_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
    <span class="n">land_mask</span> <span class="o">=</span> <span class="n">land_mask</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">land_mask</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_daily</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span>
    <span class="n">year</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">month</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">day</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">member</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">grid</span><span class="o">=</span><span class="n">default_cube</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">year</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">month</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">day</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Year, month, and day, must be specified&quot;</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">time</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cell</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span>
        <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span>
        <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="n">day</span>
    <span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">member</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cell</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">point</span> <span class="o">==</span> <span class="n">member</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/predictions_mse_corrected_structure.nc&quot;</span> <span class="o">%</span> <span class="n">Ddir</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">cube_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cube</span><span class="p">:</span> <span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">)</span>
        <span class="n">varC</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load_cube</span><span class="p">(</span>
            <span class="n">fname</span><span class="p">,</span>
            <span class="n">c1</span> <span class="o">&amp;</span> <span class="n">c2</span> <span class="o">&amp;</span> <span class="n">c3</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;unet-mse&quot;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/predictions_mse_corrected_structure.nc&quot;</span> <span class="o">%</span> <span class="n">Ddir</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">cube_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cube</span><span class="p">:</span> <span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
        <span class="n">varC</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load_cube</span><span class="p">(</span>
            <span class="n">fname</span><span class="p">,</span>
            <span class="n">c1</span> <span class="o">&amp;</span> <span class="n">c2</span> <span class="o">&amp;</span> <span class="n">c3</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;unet-asym&quot;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/predictions_emulasym_corrected_structure.nc&quot;</span> <span class="o">%</span> <span class="n">Ddir</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">cube_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cube</span><span class="p">:</span> <span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
        <span class="n">varC</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load_cube</span><span class="p">(</span>
            <span class="n">fname</span><span class="p">,</span>
            <span class="n">c1</span> <span class="o">&amp;</span> <span class="n">c2</span> <span class="o">&amp;</span> <span class="n">c3</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;diffusion&quot;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/predictions-ensemble01-sample0_Diffusion.nc&quot;</span> <span class="o">%</span> <span class="n">Ddir</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">()</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">cube_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cube</span><span class="p">:</span> <span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;pred_pr&quot;</span><span class="p">)</span>
        <span class="n">varC</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load_cube</span><span class="p">(</span>
            <span class="n">fname</span><span class="p">,</span>
            <span class="n">c1</span> <span class="o">&amp;</span> <span class="n">c2</span> <span class="o">&amp;</span> <span class="n">c3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;ensemble_member&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Hackety hack</span>
        <span class="n">varC</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">varC</span><span class="p">)</span>
        <span class="n">varC</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="mf">86400.0</span>  <span class="c1"># Convert from m/s to m/day</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown model </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model</span><span class="p">)</span>
    <span class="n">add_coord_system</span><span class="p">(</span><span class="n">varC</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Regrid, but mask out areas outside original grid</span>
        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_latitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_latitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">lon_max</span> <span class="o">=</span> <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_longitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">lon_min</span> <span class="o">=</span> <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_longitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">varC</span> <span class="o">=</span> <span class="n">varC</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Nearest</span><span class="p">())</span>
        <span class="n">latlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
            <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_longitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_latitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>
        <span class="p">)</span>
        <span class="n">varC</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">latlon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lon_min</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">latlon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lon_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">latlon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lat_min</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">latlon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lat_max</span><span class="p">),</span>
            <span class="n">varC</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">varC</span>


<span class="c1"># Switch dates using cftime</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span>
    <span class="n">year</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">month</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">day</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hour</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">member</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">grid</span><span class="o">=</span><span class="n">default_cube</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">year</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">month</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">day</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Year, month, day, and hour must be specified&quot;</span><span class="p">)</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">load_daily</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">member</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
    <span class="n">current_date</span> <span class="o">=</span> <span class="n">cftime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="s2">&quot;360_day&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hour</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">today</span>
    <span class="k">elif</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
        <span class="n">previous_day</span> <span class="o">=</span> <span class="n">current_date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">load_daily</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">previous_day</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
            <span class="n">previous_day</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
            <span class="n">previous_day</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
            <span class="n">member</span><span class="p">,</span>
            <span class="n">grid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">CubeList</span><span class="p">([</span><span class="n">prev</span><span class="p">,</span> <span class="n">today</span><span class="p">])</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">merge_cube</span><span class="p">()</span>
        <span class="n">interpolated</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
            <span class="p">[(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">current_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="n">hour</span><span class="p">))],</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">interpolated</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># hour&gt; 12</span>
        <span class="n">next_day</span> <span class="o">=</span> <span class="n">current_date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="n">load_daily</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">next_day</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
            <span class="n">next_day</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
            <span class="n">next_day</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
            <span class="n">member</span><span class="p">,</span>
            <span class="n">grid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">CubeList</span><span class="p">([</span><span class="n">today</span><span class="p">,</span> <span class="nb">next</span><span class="p">])</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">merge_cube</span><span class="p">()</span>
        <span class="n">interpolated</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
            <span class="p">[(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">current_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="n">hour</span><span class="p">))],</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">interpolated</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_3hr</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span>
    <span class="n">year</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">month</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">day</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hour</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">grid</span><span class="o">=</span><span class="n">default_cube</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">year</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">month</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">day</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Year, month, and day, must be specified&quot;</span><span class="p">)</span>
    <span class="n">fyr</span> <span class="o">=</span> <span class="n">year</span>
    <span class="k">if</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">12</span> <span class="ow">and</span> <span class="p">(</span><span class="n">day</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">hour</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">fyr</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;/data/scratch/tomas.wetherell/create_dataset/01/3hrinst_dataset_</span><span class="si">%04d</span><span class="s2">.nc&quot;</span> <span class="o">%</span> <span class="n">fyr</span>
    <span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">time</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cell</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span>
        <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span>
        <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="n">day</span>
        <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="n">hour</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">cube_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cube</span><span class="p">:</span> <span class="n">cube</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;precipitation_flux&quot;</span><span class="p">)</span>
        <span class="n">varC</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load_cube</span><span class="p">(</span>
            <span class="n">fname</span><span class="p">,</span>
            <span class="n">c1</span> <span class="o">&amp;</span> <span class="n">c3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">varC</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">varC</span><span class="p">)</span>
        <span class="n">varC</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">varC</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="mf">86400.0</span>  <span class="c1"># Convert from m/s to m/day</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown model </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model</span><span class="p">)</span>
    <span class="n">add_coord_system</span><span class="p">(</span><span class="n">varC</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Regrid, but mask out areas outside original grid</span>
        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_latitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_latitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">lon_max</span> <span class="o">=</span> <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_longitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">lon_min</span> <span class="o">=</span> <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_longitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">varC</span> <span class="o">=</span> <span class="n">varC</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Nearest</span><span class="p">())</span>
        <span class="n">latlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
            <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_longitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">varC</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;grid_latitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>
        <span class="p">)</span>
        <span class="n">varC</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">latlon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lon_min</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">latlon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lon_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">latlon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lat_min</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">latlon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lat_max</span><span class="p">),</span>
            <span class="n">varC</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">varC</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_3hr_i</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span>
    <span class="n">year</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">month</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">day</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hour</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">grid</span><span class="o">=</span><span class="n">default_cube</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">year</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">month</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">day</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Year, month, day, and hour must be specified&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hour</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">minute</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_3hr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hour</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">b_hour</span> <span class="o">=</span> <span class="n">hour</span> <span class="o">-</span> <span class="n">hour</span> <span class="o">%</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b_hour</span> <span class="o">=</span> <span class="n">hour</span>
    <span class="n">b_field</span> <span class="o">=</span> <span class="n">load_3hr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">b_hour</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
    <span class="n">e_hour</span> <span class="o">=</span> <span class="n">b_hour</span> <span class="o">+</span> <span class="mi">3</span>
    <span class="n">current_date</span> <span class="o">=</span> <span class="n">cftime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="s2">&quot;360_day&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">e_hour</span> <span class="o">==</span> <span class="mi">24</span><span class="p">:</span>
        <span class="n">e_hour</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">next_day</span> <span class="o">=</span> <span class="n">current_date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">next_day</span><span class="o">.</span><span class="n">year</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">next_day</span><span class="o">.</span><span class="n">month</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">next_day</span><span class="o">.</span><span class="n">day</span>
    <span class="n">e_field</span> <span class="o">=</span> <span class="n">load_3hr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">e_hour</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">CubeList</span><span class="p">([</span><span class="n">b_field</span><span class="p">,</span> <span class="n">e_field</span><span class="p">])</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">merge_cube</span><span class="p">()</span>
    <span class="n">interpolated</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">([(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">current_date</span><span class="p">)],</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">interpolated</span>
</pre></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo of Video Diagnostics"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ERA5/index.html">Near-surface temperature, wind, and precipitation. From the ERA5 Reanalysis</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ERA5/index.html">ERA5 weather</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SyCLoPS/index.html">SyCLoPS weather events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SyCLoPS%2BERA5/index.html">SyCLoPS events &amp; ERA5 weather</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Downscaling: Diffusion model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Downscaling_UNet/index.html">Downscaling: UNet model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Downscaling_3hrly/index.html">Downscaling: 3-hourly data</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../how_to.html">How to reproduce or extend this work</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Authors and acknowledgements</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/Animations-hackathon">Get the code</a></h3>

<ul>
<li><a href="https://github.com/philip-brohan/Animations-hackathon"
           rel="nofollow">Github repository</a></li>
<li><a href="https://github.com/philip-brohan/Animations-hackathon/archive/master.zip"
           rel="nofollow">Zip file</a></li>
</ul>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/Animations-hackathon/issues/new">raise an issue</a><br>or <a href="mailto://philip.brohan@metoffice.gov.uk">contact Philip</a>.
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="plot.html" title="Plot one frame of the ML Downscaling Diffusion video"
             >next</a></li>
        <li class="right" >
          <a href="index.html" title="Downscaling: Diffusion model"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Video Diagnostics</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Downscaling: Diffusion model</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Assemble data for the ML Diffusion video</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>